import org.yaml.snakeyaml.Yaml

buildscript {
    repositories {
        mavenCentral()
        mavenLocal()
        gradlePluginPortal()
    }

    def selfFormatVersion = '0.1.0'
    def m2Dir = new File(
            "${System.getProperty('user.home')}/.m2/repository/ca/kieve/java-formatter/${selfFormatVersion}")

    dependencies {
        classpath 'org.yaml:snakeyaml:2.3'
        if (m2Dir.exists()) {
            classpath "ca.kieve:java-formatter:${selfFormatVersion}"
        }
    }
}

plugins {
    id 'java-gradle-plugin'
    id 'maven-publish'
}

// Apply self-formatting plugin from mavenLocal if available.
// Run './gradlew publishToMavenLocal' to bootstrap.
if (buildscript.configurations.classpath.any { it.name.startsWith('java-formatter') }) {
    apply plugin: 'ca.kieve.java-formatter'
} else {
    logger.lifecycle('Self-formatting not available. ' +
            'Run \'./gradlew publishToMavenLocal\' to enable.')
}

group = 'ca.kieve'
version = '0.1.0'

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(25)
    }
}

repositories {
    mavenCentral()
    gradlePluginPortal()
}

gradlePlugin {
    plugins {
        javaFormatter {
            id = 'ca.kieve.java-formatter'
            implementationClass = 'ca.kieve.formatter.JavaFormatterPlugin'
        }
    }
}

// --- Eclipse formatter: YAML -> XML generation ---

def generatedResourcesDir = layout.buildDirectory.dir('generated-resources')

sourceSets {
    main {
        resources {
            srcDir generatedResourcesDir
        }
    }
}

tasks.register('generateEclipseConfig') {
    def yamlFile = file('src/main/formatter/eclipse-formatter.yaml')
    def outputFile = generatedResourcesDir.map { it.file('eclipse-formatter.xml') }

    inputs.file(yamlFile)
    outputs.file(outputFile)

    doLast {
        def yaml = new Yaml()
        def config = yaml.load(yamlFile.text)

        def settings = new TreeMap<String, String>()
        def flatten
        flatten = { Map map, String prefix ->
            map.each { key, value ->
                def fullKey = prefix ? "${prefix}.${key}" : key.toString()
                if (value instanceof Map) {
                    flatten(value, fullKey)
                } else {
                    settings[fullKey] = value.toString()
                }
            }
        }
        flatten(config, '')

        def xml = new StringBuilder()
        xml.append('<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n')
        xml.append('<profiles version="22">\n')
        xml.append('    <profile kind="CodeFormatterProfile" name="KieveStyle" version="22">\n')
        settings.each { id, value ->
            def escapedValue = value
                .replace('&', '&amp;')
                .replace('<', '&lt;')
                .replace('>', '&gt;')
                .replace('"', '&quot;')
            xml.append("        <setting id=\"${id}\" value=\"${escapedValue}\"/>\n")
        }
        xml.append('    </profile>\n')
        xml.append('</profiles>\n')

        def outFile = outputFile.get().asFile
        outFile.parentFile.mkdirs()
        outFile.text = xml.toString()
    }
}

tasks.named('processResources') {
    dependsOn 'generateEclipseConfig'
}

// --- end Eclipse formatter generation ---

dependencies {
    // Spotless Gradle plugin â€” brings in spotless-lib transitively
    implementation 'com.diffplug.spotless:spotless-plugin-gradle:8.2.1'

    // JavaParser for AST parsing and transformation
    implementation 'com.github.javaparser:javaparser-core:3.28.0'

    // Jackson YAML for reading kieve-formatter.yaml config files
    implementation 'com.fasterxml.jackson.dataformat:jackson-dataformat-yaml:2.18.2'

    // Testing
    testImplementation gradleTestKit()
    testImplementation platform('org.junit:junit-bom:5.11.4')
    testImplementation 'org.junit.jupiter:junit-jupiter'
    testRuntimeOnly 'org.junit.platform:junit-platform-launcher'

    // Eclipse JDT for direct (in-process) formatter tests
    testImplementation 'org.eclipse.jdt:org.eclipse.jdt.core:3.40.0'
    testImplementation 'org.eclipse.platform:org.eclipse.text:3.14.200'

    // Checkstyle for in-process lint tests
    testImplementation 'com.puppycrawl.tools:checkstyle:10.22.0'
}


tasks.named('test') {
    useJUnitPlatform()
    maxParallelForks = 16
    jvmArgs '--enable-native-access=ALL-UNNAMED'

    testLogging {
        events 'failed'
        showExceptions = true
        showCauses = true
        showStackTraces = false
        exceptionFormat = 'full'
    }
}

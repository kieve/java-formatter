import org.yaml.snakeyaml.Yaml

buildscript {
    repositories {
        mavenCentral()
    }
    dependencies {
        classpath 'org.yaml:snakeyaml:2.3'
    }
}

plugins {
    id 'java-gradle-plugin'
}

group = 'ca.kieve'
version = '0.1.0'

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(25)
    }
}

repositories {
    mavenCentral()
    gradlePluginPortal()
}

gradlePlugin {
    plugins {
        javaFormatter {
            id = 'ca.kieve.java-formatter'
            implementationClass = 'ca.kieve.formatter.JavaFormatterPlugin'
        }
    }
}

// --- Eclipse formatter: YAML -> XML generation ---

def generatedResourcesDir = layout.buildDirectory.dir('generated-resources')

sourceSets {
    main {
        resources {
            srcDir generatedResourcesDir
        }
    }
}

tasks.register('generateEclipseConfig') {
    def yamlFile = file('src/main/formatter/eclipse-formatter.yaml')
    def outputFile = generatedResourcesDir.map { it.file('eclipse-formatter.xml') }

    inputs.file(yamlFile)
    outputs.file(outputFile)

    doLast {
        def yaml = new Yaml()
        def config = yaml.load(yamlFile.text)

        def settings = new TreeMap<String, String>()
        def flatten
        flatten = { Map map, String prefix ->
            map.each { key, value ->
                def fullKey = prefix ? "${prefix}.${key}" : key.toString()
                if (value instanceof Map) {
                    flatten(value, fullKey)
                } else {
                    settings[fullKey] = value.toString()
                }
            }
        }
        flatten(config, '')

        def xml = new StringBuilder()
        xml.append('<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n')
        xml.append('<profiles version="22">\n')
        xml.append('    <profile kind="CodeFormatterProfile" name="KieveStyle" version="22">\n')
        settings.each { id, value ->
            def escapedValue = value
                .replace('&', '&amp;')
                .replace('<', '&lt;')
                .replace('>', '&gt;')
                .replace('"', '&quot;')
            xml.append("        <setting id=\"${id}\" value=\"${escapedValue}\"/>\n")
        }
        xml.append('    </profile>\n')
        xml.append('</profiles>\n')

        def outFile = outputFile.get().asFile
        outFile.parentFile.mkdirs()
        outFile.text = xml.toString()
    }
}

tasks.named('processResources') {
    dependsOn 'generateEclipseConfig'
}

// --- end Eclipse formatter generation ---

dependencies {
    // Spotless Gradle plugin â€” brings in spotless-lib transitively
    implementation 'com.diffplug.spotless:spotless-plugin-gradle:8.2.1'

    // JavaParser for AST parsing and transformation
    implementation 'com.github.javaparser:javaparser-core:3.28.0'

    // Testing
    testImplementation gradleTestKit()
    testImplementation platform('org.junit:junit-bom:5.11.4')
    testImplementation 'org.junit.jupiter:junit-jupiter'
    testRuntimeOnly 'org.junit.platform:junit-platform-launcher'
}

tasks.named('test') {
    useJUnitPlatform()
    maxParallelForks = 16
    jvmArgs '--enable-native-access=ALL-UNNAMED'

    testLogging {
        events 'failed'
        showExceptions = true
        showCauses = true
        showStackTraces = false
        exceptionFormat = 'full'
    }
}
